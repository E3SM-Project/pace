{% extends "layout.html" %}
{% block content %}
{% block topcontent %}

<link href="https://unpkg.com/tabulator-tables@5.0.7/dist/css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.0.7/dist/js/tabulator.min.js"></script>
<style>
.runtimeTable th, .runtimeTable td{
    border:1px solid;
}
.runtimeTable{
    background-color:#F0F0F0;
    font-family:monospace;
    color:#444;
}

.inBlock{
    display:inline-block;
}
#runtimeImg{
    width:auto;
    max-width:7in;
    height:auto;
    /*margin-top:-25%*/
}

.fleft {
    float:left;
    width:39%;
}

.fright {
    float: right;
    width:55%;
}
</style>
{% endblock topcontent %}

<!-- new design exp-details-->

<p>
    <div style="overflow:scroll ; border:4px solid black;background-color:#EEE">
        <h1 style="text-align: center">Experiment Details</h1>
        <!--Pre's take *everything literally, so everyting inside this pre is unformatted...-->
        <div class="wrap" style="padding:10px;width:auto;border-radius:5px;font-family:menlo">
            <div class="fleft">
                <span style='color:crimson'>Id:</span> {{exp.expid}}<br>
                <span style='color:crimson'>User:</span> {{exp.user}} <br>
                <span style='color:crimson'>JobID:</span> {{exp.lid}}<br>
                <span style='color:crimson'>Machine:</span> {{exp.machine}}<br> 
                <span style='color:crimson'>Compset:</span> {{exp.compset}}<br> 
                <span style='color:crimson'>Case:</span> {{exp.case}}<br>
                <span style='color:crimson'>Res:</span> {{exp.res}}<br> 
                <span style='color:crimson'>Version:</span> {{exp.version}}<br>
                <span style='color:crimson'>Date:</span> {{exp.exp_date}}<br>
                <span style='color:crimson'>Run_time:</span> {{ exp.run_time }} sec<br>
                <span style='color:crimson'>Init time:</span> {{ exp.init_time }} sec<br>
                <span style='color:crimson'>Final_time:</span> {{ exp.final_time }} sec<br>
                <span style='color:crimson'>Total PEs:</span> {{exp.total_pes_active}}<br>
                <span style='color:crimson'>Model cost:</span> {{exp.model_cost}} pe-hrs/sim_year<br>
                <span style='color:crimson'>Run length:</span> {{exp.run_length}} days<br>
                <span style='color:crimson'>Stop_n:</span> {{exp.stop_n}}<br>
                <span style='color:crimson'>Stop Option:</span> {{ exp.stop_option}}<br>
                <span style='color:crimson'>MPI tasks/node:</span> {{exp.mpi_tasks_per_node}}<br>
                
                <br>
                <span style='color:crimson'><b>Model Throughput</b>:</span> {{exp.model_throughput}} SYPD
                <br>
                <br>
                <span style='color:crimson'>Additional Notes:</span>
            </div>
            <div class="fright">
                <span style='color:crimson'><b>Graphs:</b></span>
                <br>
                <span style='padding-left:5em'> <a href="/summary/{{expid}}/stats">Summary Global statistics</a></span>
                <br>
                <span style='color:crimson'>Tree graph :</span><br>
                <span style='padding-left:5em'>{% for rank in ranks -%}<a href="/summary/{{expid}}/{{rank.rank}}">Rank {{rank.rank}}</a> &nbsp;</span>
                            {%- endfor %}
                <br>
                <span style='color:crimson'>Flame graph :</span> <br>
                <span style="padding-left:5em">{% for rank in ranks -%}<a href="/flamegraph/{{expid}}/{{rank.rank}}">Rank {{rank.rank}}</a> &nbsp;</span>
                            {%- endfor %}
                <br>
                <span style='color:crimson'>Component Process :</span> <br>
                <span style="padding-left:5em;"><a href="/atmos/{{exp.expid}}">Atm process distribution</a></span>
                <br>
                <span style='color:crimson'><b>Scorpio IO Stats:</b></span><br>
                <span style="padding-left:5em;"><a href="/scorpio/{{expid}}">Scorpio I/O statistics</a></span>
                <br>
                <span style='color:crimson'><b>Memory Usage Profile:</b></span><br>
                <span style="padding-left:5em;"><a href="/memoryprofile/{{expid}}">Memory Usage Profile</a></span>
                <br>
                <span style='color:crimson'><b>Build Time Profile:</b></span><br>
                <span style="padding-left:5em;"><a href="/buildtime/{{expid}}">Build Time Profile</a></span>
            </div>
            <br>
            <br>
            
            <textarea style="resize:both" id="note" name="note" class="form-control" readonly>{{note}}</textarea><p style="text-align:center;margin-top:5px"><a href="/note/{{exp.expid}}"><input type="button" style = "text-align:center" value="Add/Edit" class="btn btn-outline-secondary"/><br></p>
            <!--Static file loc on web server-->
            <!--<a href="/static/data/exp-{{exp.user}}-{{exp.expid}}.zip">Download Raw Data</a>-->
            <!--From file server-->
            <a href="https://pacefs.ornl.gov/e3sm/exp-{{exp.user}}-{{exp.expid}}.zip">Download Raw Data</a>
       </div>
    </div>
    <div style="overflow:scroll ; border:4px solid black;margin-top:50px;background-color:#EEE;">
        <h3 style="text-align: center;margin-bottom:25px;">Model Componenet</h3>
        <div class="wrap" style="padding:10px">
            <div class="fleft" id="compTable"></div>
            <div class="fright">
                <img id="runtimeImg"/>
            </div>
        </div>
    </div>
    <div style="overflow:scroll ; border:4px solid black;margin-top:50px; margin-bottom:100px;background-color:#EEE">
        <h3 style="text-align: center;margin-bottom:25px;">Model Input Files</h3>
        <table style="width:100%; border: 1px solid black">
            <tr>
                <th style="border: 1px solid black">XML Inputs:</th>
                <th style="border: 1px solid black">Namelist Inputs:</th>
                <th style="border: 1px solid black">RC Inputs:</th>
            </tr>
            <tr>
                <td style="border: 1px solid black">
                    {%for name in xmls%}
                    <a href="/xmlviewer/{{exp.expid}}/{{name[0]}}">{{name[0]}}</a><br>
                    {%endfor%}
                </td>
                <td style="border: 1px solid black">
                    {%for name in nmls%}
                    <a href="/nmlviewer/{{exp.expid}}/{{name[0]}}">{{name[0]}}</a><br>
                    {%endfor%}
                </td>
                <td style="border: 1px solid black">
                    {%for name in rcs%}
                    <a href="/rcviewer/{{exp.expid}}/{{name[0]}}">{{name[0]}}</a><br>
                    {%endfor%}
                </td>
            </tr>
        </table>
    </div>
</p>
<script>
var imgLink = detectRootUrl()+"svg/runtime/{{expid}}";
runtimeImg.src=imgLink;

//Format the expsummary!
//{
//    let lines = expsummary.innerHTML.split("\n");
//    expsummary.innerHTML="";
//    lines.forEach(element=>{
//        elSplit = element.split(":");
//        expsummary.innerHTML+="<span style='color:crimson'>"+elSplit[0]+""+(elSplit[1]?":</span><b>"+elSplit[1]+"</b>\n":"</span>");
//    });
//}

//var chartColors = JSON.parse(`{{chartColors|safe}}`);
//var colorLegend = document.getElementsByClassName("colorElement");
//var elNames = document.getElementsByClassName("elementName");
//for(var i = 0;i<colorLegend.length;i++){
//    if(chartColors[elNames[i].innerHTML])
//        colorLegend[i].style.backgroundColor = chartColors[elNames[i].innerHTML];
//}

var compRunTime = {{runtimes|tojson}}
var compcolor = {
    "ATM": "#66ccff",
    "CPL": "#ff9900",
    "GLC": "#FF99CC",
    "ICE": "#00FFFF",
    "LND": "#00ff40",
    "OCN": "#0000FF80",
    "ROF": "#FF0000",
    "WAV": "#0000B0"
}
var fieldDic = {
    "color":"Color",
    "comp":"Component",
    "run_time":"Run Time(s)",
    "throughput":"Throughput(SYPD)"
};

var newCompRunTime = [];
var color = "";
for(i = 0; i<compRunTime.length;i++){
    if(compRunTime[i]["component"] in compcolor){
        color = compcolor[compRunTime[i]["component"]];
    }else{
        color = "#ffffff";
    }
    
    newCompRunTime.push({
        "color":color,
        "comp":compRunTime[i]["component"],
        "run_time":compRunTime[i]["seconds"],
        "throughput":compRunTime[i]["model_years"]
    });
}

var comptable = new Tabulator("#compTable", {
    data:newCompRunTime,
    layout:"fitDataStretch",
    initialSort:[
        {column:"run_time", dir:"desc"},
    ],
    columns:[
    {title:fieldDic["color"], field:"color", hozAlign:"right", formatter:"color", width:75},
    {title:fieldDic["comp"], field:"comp", hozAlign:"right"},
    {title:fieldDic["run_time"], field:"run_time", hozAlign:"right",sorter:"number",formatter:"money", formatterParams:{precision:3}},
    {title:fieldDic["throughput"], field:"throughput", hozAlign:"right",formatter:"money", formatterParams:{precision:2}},
    ],
});
</script>

{% endblock %}
